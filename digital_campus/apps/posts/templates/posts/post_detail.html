{% extends "digital_campus/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% block content %}

<!-- Styleing (Css) -->
<link rel="stylesheet" href="{% static 'digital_campus/css/post_detail.css' %}">

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Post Detail JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<article class="post-card mb-4 shadow-sm">

  {# --- BODY with padding ------------------------------------------------- #}
  <div class="p-4 d-flex">

      {# Avatar ------------------------------------------------------------ #}
      {% if object.author.profile.image %}
        <img src="{{ object.author.profile.image.url }}" class="rounded-circle article-img me-3" alt="{{ object.author.username }}">
      {% else %}
        <img src="{% static 'digital_campus/images/default.jpg' %}" class="rounded-circle article-img me-3" alt="Default avatar">
      {% endif %}

      {# Content column ---------------------------------------------------- #}
      <div class="media-body w-100">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="article-metadata mb-2">
              <a href="{% url 'common:user-posts' object.author.username %}" class="link-primary fw-semibold">
                {{ object.author }}
              </a>
              <small class="text-muted ms-2">{{ object.date_posted|date:"F d, Y" }}</small>
            </div>
            <h2 class="article-title">{{ object.title }}</h2>
          </div>
      
          {% if object.author == user %}
          <div class="dropdown ml-auto">

            <button class="btn border-0 bg-transparent text-white fs-5" id="postMenu{{ object.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="bi bi-three-dots" style="font-size: 1.5rem;"></i>
            </button>

            <div class="dropdown-menu custom-dropdown-menu dropdown-menu-right">
              <a class="dropdown-item d-flex align-items-center" href="{% url 'posts:post-update' object.id %}">
                <i class="bi bi-pencil-square mr-2"></i> Edit
              </a>
              <a class="dropdown-item d-flex align-items-center text-danger" href="{% url 'posts:post-delete' object.id %}">
                <i class="bi bi-trash mr-2"></i> Delete
              </a>
            </div>
            
          </div>
          {% endif %}
          
        </div>
      
        <div class="collapsible-content collapsed">
          {% for attach in object.attachments.all %}
              {% if attach.media_type == 'image' %}
                <div class="mb-3">
                  <img src="{{ attach.file.url }}" class="img-fluid rounded post-media">
                </div>
              {% else %}
                <div class="mb-3">
                  <video controls muted playsinline class="w-100 rounded post-media">
                    <source src="{{ attach.file.url }}" type="video/mp4">
                  </video>
                </div>
              {% endif %}
          {% endfor %}
      
          <p class="mb-3">{{ object.content|safe }}</p>
        </div>
      
        <div class="expand-toggle">
          <i class="bi bi-chevron-down"></i>
        </div>
      </div>
      

  </div>  {# /p‑4 body #}

  {# --- FULL‑WIDTH REACTION BAR ------------------------------------------ #}
  
  <!-- HTML: Updated Reaction Bar with Animated Custom Share Menu -->
  <div class="reaction-bar">
    <button class="btn" id="like-btn-{{ object.id }}" onclick="toggleLike('{{ object.id }}')">
      <i class="bi bi-hand-thumbs-up"></i><span>Like</span>
    </button>
    <button class="btn" data-bs-toggle="collapse" data-bs-target="#add-comment-{{ object.id }}">
      <i class="bi bi-chat-left"></i><span>Comment</span>
    </button>
    <button class="btn" onclick="toggleShareMenu('{{ object.id }}')">
      <i class="bi bi-share"></i><span>Share</span>
    </button>
  </div>

  <!-- Share Menu -->
  <div id="share-menu-{{ object.id }}" class="share-menu collapse mt-2">
    <div class="share-menu-inner p-3 rounded bg-dark text-white shadow position-relative">
      <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" aria-label="Close" onclick="closeShareMenu('{{ object.id }}')"></button>
      <div class="d-flex flex-column gap-2">
        <button onclick="copyLink('{{ object.id }}')" class="share-btn btn btn-outline-light d-flex align-items-center">
          <img src="{% static 'digital_campus/icons/copy.svg' %}" alt="Copy" class="me-2" /> Copy Link
        </button>
        <a id="twitter-share-{{ object.id }}" class="share-btn btn btn-outline-primary d-flex align-items-center" target="_blank">
          <img src="{% static 'digital_campus/icons/twitter.svg' %}" alt="Twitter" class="me-2" /> Twitter
        </a>
        <a id="whatsapp-share-{{ object.id }}" class="share-btn btn btn-outline-success d-flex align-items-center" target="_blank">
          <img src="{% static 'digital_campus/icons/whatsapp.svg' %}" alt="WhatsApp" class="me-2" /> WhatsApp
        </a>
        <button onclick="copyInstagramLink('{{ object.id }}')" class="share-btn btn btn-outline-danger d-flex align-items-center">
          <img src="{% static 'digital_campus/icons/instagram.svg' %}" alt="Instagram" class="me-2" /> Instagram
        </button>
      </div>
    </div>
  </div>

</article> 


<!-- Comments -->
<!-- Comments Always Visible -->
<div id="comment-section-{{ object.id }}" class="mt-4">
  <h3 class="mb-4">Comments</h3>

  {% for comment in post.comments.all %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <strong>{{ comment.user }}</strong>
          <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
        </div>
        <p class="mt-2 mb-0">{{ comment.content }}</p>
      </div>
    </div>
  {% empty %}
    <p class="text-muted">No comments yet.</p>
  {% endfor %}

  {% if user.is_authenticated %}
    <button
      class="btn btn-outline-primary mb-3"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#add-comment-{{ object.id }}"
    >
      Add Comment
    </button>

    <div id="add-comment-{{ object.id }}" class="collapse">
      <form action="{% url 'posts:add_comment' post.id %}" method="POST" class="card p-3 shadow-sm">
        {% csrf_token %}
        <div class="form-group mb-3">
          {{ form.content.label_tag }}
          {{ form.content|add_class:"form-control" }}
        </div>
        <button type="submit" class="btn btn-primary">Post Comment</button>
      </form>
    </div>
  {% else %}
    <p class="mt-3"><a href="{% url 'login' %}">Log in</a> to comment.</p>
  {% endif %}
</div>

<script src="{% static 'digital_campus/js/post_detail.js' %}"></script>

{% endblock %}
