{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
    <title>Chat - {{ room_name }}</title>
    <link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
</head>
<body>
<div id="chat-container">
    <!-- Left side: room list (optional if you have multiple rooms) -->
    <div id="rooms-list">
        <!-- You could dynamically list rooms the user is in -->
        <div class="room-item">{{ room_name }}</div>
    </div>

    <!-- Right side: main chat -->
    <div id="chat-content">
        <div id="chat-log">
            <!-- Render old messages from the DB first -->
            {% for msg in messages %}
                <div class="chat-message">
                    <img class="profile-pic" src="{{ msg.user.profile.image.url }}" alt="Profile">
                    <span class="username">{{ msg.user.username }}</span>
                    <span class="timestamp">{{ msg.timestamp|date:"H:i" }}</span>
                    <div class="message-content">
                        {{ msg.content }}
                    </div>
                    
                    {% if msg.attachments.all %}
                        <div class="attachments">
                            {% for attach in msg.attachments.all %}
                                {% if attach.file.name|lower|endswith:".png" or attach.file.name|lower|endswith:".jpg" or attach.file.name|lower|endswith:".jpeg" or attach.file.name|lower|endswith:".gif" %}
                                    <!-- Image preview -->
                                    {% if attach.thumbnail %}
                                        <img src="{{ attach.thumbnail.url }}" style="max-width:200px;"/>
                                    {% else %}
                                        <img src="{{ attach.file.url }}" style="max-width:200px;"/>
                                    {% endif %}
                                {% elif attach.file.name|lower|endswith:".mp4" or attach.file.name|lower|endswith:".mov" or attach.file.name|lower|endswith:".webm" %}
                                    <!-- Video preview -->
                                    <video controls width="300">
                                        <source src="{{ attach.file.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <!-- Generic file link -->
                                    <a href="{{ attach.file.url }}" target="_blank">Download File</a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <div id="typing-indicator" style="display:none;"></div>

        <div id="message-input-container">
            <input id="chat-message-input" type="text" placeholder="Type your message...">
            <button id="chat-message-send">Send</button>
        </div>

        <!-- File Upload Form -->
        <form id="fileUploadForm" enctype="multipart/form-data" method="POST" style="padding:10px;">
            {% csrf_token %}
            <input type="file" name="file" id="fileInput">
            <input type="hidden" name="room_name" value="{{ room_name }}">
            <button type="submit">Upload</button>
        </form>
    </div>
</div>

<script src="{% static 'digital_campus/js/jquery-3.5.1.min.js' %}"></script>
<script>
  const roomName = "{{ room_name }}";
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const chatSocket = new WebSocket(
      protocol + '://' + window.location.host + '/ws/chat/' + roomName + '/'
  );

  const chatLog = document.querySelector("#chat-log");
  const typingIndicator = document.querySelector("#typing-indicator");
  const chatMessageInput = document.querySelector("#chat-message-input");

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      if (data.type === 'text') {
          // Create a new DOM element for the message
          const msgDiv = document.createElement('div');
          msgDiv.classList.add('chat-message');
          
          // Profile pic
          const profilePic = document.createElement('img');
          profilePic.classList.add('profile-pic');
          profilePic.src = data.profile_pic_url ? data.profile_pic_url : '{% static "media/default.jpg" %}';
          msgDiv.appendChild(profilePic);
          
          // Username
          const usernameSpan = document.createElement('span');
          usernameSpan.classList.add('username');
          usernameSpan.textContent = data.username;
          msgDiv.appendChild(usernameSpan);

          // Timestamp
          const timestampSpan = document.createElement('span');
          timestampSpan.classList.add('timestamp');
          timestampSpan.textContent = " " + data.timestamp;
          msgDiv.appendChild(timestampSpan);

          // Message content
          const contentDiv = document.createElement('div');
          contentDiv.classList.add('message-content');
          contentDiv.textContent = data.message;
          msgDiv.appendChild(contentDiv);

          chatLog.appendChild(msgDiv);
          chatLog.scrollTop = chatLog.scrollHeight;
      } else if (data.type === 'typing') {
          typingIndicator.style.display = 'block';
          typingIndicator.textContent = data.user + " is typing...";
          setTimeout(() => {
              typingIndicator.style.display = 'none';
          }, 2000);
      }
  };

  chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  // Send message
  document.querySelector("#chat-message-send").onclick = function(e) {
      const message = chatMessageInput.value.trim();
      if (message.length > 0) {
          chatSocket.send(JSON.stringify({
              'message': message,
              'type': 'text'
          }));
          chatMessageInput.value = '';
      }
  };

  // Typing indicator
  chatMessageInput.onkeyup = function(e) {
      chatSocket.send(JSON.stringify({
          'type': 'typing'
      }));
  };

  // File upload
  $("#fileUploadForm").submit(function(e) {
      e.preventDefault();
      let formData = new FormData(this);
      $.ajax({
          url: "{% url 'chat-file-upload' %}",
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
              // Optionally, you could send a message about the new file
              chatSocket.send(JSON.stringify({
                  'message': 'Uploaded a file',
                  'type': 'text'
              }));
          },
          error: function(err) {
              console.log(err);
          }
      });
  });
</script>
</body>
</html>
