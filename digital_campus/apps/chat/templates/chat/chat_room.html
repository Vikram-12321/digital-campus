{% extends "digital_campus/base.html" %}

{% load static %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ room.name }}</title>

    <!--  Bootstrap 4  -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
    <!--  Bootstrap-Icons  -->
    <link rel="stylesheet" href="{% static 'bootstrap-icons/font/bootstrap-icons.css' %}">
    <!--  Chat CSS  -->
    <link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
</head>
<body class="bg-dark text-light d-flex flex-column vh-100">

<!-- ---------- HEADER ---------- -->
<nav class="navbar navbar-dark bg-secondary">
    <span class="navbar-brand mb-0 h5">
        <i class="bi bi-chat-dots"></i> {{ room.name }}
    </span>
</nav>

<!-- ---------- MESSAGES ---------- -->
<main id="messages-container" class="flex-grow-1 overflow-auto p-3">
    {% for msg in messages %}
        {% include "chat/partials/message.html" with msg=msg %}
    {% endfor %}
</main>

<!-- ---------- TYPING INDICATOR ---------- -->
<div id="typing-indicator" class="px-3 py-1 text-muted small" style="display:none;">
    <i class="bi bi-pencil"></i> <span id="typing-user"></span> is typing…
</div>

<!-- ---------- COMPOSER ---------- -->
<form id="composer" class="d-flex p-2 border-top bg-secondary" autocomplete="off">
    <input id="msg-input" class="form-control mr-2" placeholder="Type a message…" />
    <label class="btn btn-outline-light mb-0 mr-2">
        <i class="bi bi-paperclip"></i>
        <input id="file-input" type="file" hidden>
    </label>
    <button id="send-btn" class="btn btn-primary"><i class="bi bi-send"></i></button>
</form>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="{% static 'chat/js/chat.js' %}"></script>

<!-- Feed template-vars to JS -->
 <script>
    // chat.js
(function () {
  const { roomName, userName, uploadUrl, csrfToken } = window.CHAT;
  const socket = new WebSocket(`ws://${location.host}/ws/chat/${roomName}/`);

  /* ---------- DOM ---------- */
  const $messages = $('#messages-container');
  const $msgInput = $('#msg-input');
  const $typing = $('#typing-indicator');
  const $typingUser = $('#typing-user');
  const $fileInput = $('#file-input');

  /* ---------- Helpers ---------- */
  const scrollBottom = () => $messages.prop('scrollTop', $messages.prop('scrollHeight'));

  const renderMessage = data => {
    const { username, message, profile_pic_url, timestamp } = data;

    const $media = $(`
      <div class="media mb-3">
         <img src="${profile_pic_url || 'https://via.placeholder.com/40'}"
              class="mr-3 rounded-circle" width="40" height="40">
         <div class="media-body">
             <h6 class="mt-0 mb-1">${username}
               <small class="text-muted">${timestamp}</small>
             </h6>
             <p class="mb-1">${message || ''}</p>
         </div>
      </div>`);
    $messages.append($media);
    scrollBottom();
  };

  /* ---------- WebSocket events ---------- */
  socket.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'typing') {
      if (data.user !== userName) {
        $typingUser.text(data.user);
        $typing.show();
        clearTimeout($typing.data('timeout'));
        $typing.data('timeout', setTimeout(() => $typing.hide(), 1500));
      }
    } else {
      $typing.hide();
      renderMessage(data);
    }
  };

  socket.onclose = () => console.warn('Socket closed');

  /* ---------- Send text ---------- */
  $('#composer').on('submit', e => {
    e.preventDefault();
    const msg = $msgInput.val().trim();
    if (msg) {
      socket.send(JSON.stringify({ message: msg }));
      $msgInput.val('');
    }
  });

  /* ---------- Typing indicator ---------- */
  let typingTimeout;
  $msgInput.on('input', () => {
    clearTimeout(typingTimeout);
    socket.send(JSON.stringify({ type: 'typing' }));
    typingTimeout = setTimeout(() => {}, 1000);
  });

  /* ---------- File upload ---------- */
  $fileInput.on('change', () => {
    const file = $fileInput[0].files[0];
    if (!file) return;

    const form = new FormData();
    form.append('file', file);
    form.append('room_name', roomName);

    fetch(uploadUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: form,
    })
    .then(r => r.json())
    .then(() => {
        socket.send(JSON.stringify({ message: `${userName} sent a file.` }));
    })
    .catch(console.error);
  });

  /* ---------- Auto-scroll on load ---------- */
  $(document).ready(scrollBottom);
})();

 </script>
<script>
  window.CHAT = {
      roomName: "{{ room.name|escapejs }}",
      userName: "{{ request.user.username|escapejs }}",
      uploadUrl: "{% url 'chat-file-upload' %}",
      csrfToken: "{{ csrf_token }}",
  };
</script>
</body>
</html>

{% endblock %}
