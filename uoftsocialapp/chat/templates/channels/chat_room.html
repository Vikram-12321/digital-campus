{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Chat Room - {{ room_name }}</title>
    <link rel="stylesheet" href="{% static 'channels/css/chat.css' %}">
</head>
<body>
    <h2>Chat Room: {{ room_name }}</h2>
    <div id="chat-log" style="border:1px solid #ccc; height: 300px; overflow-y: scroll;">
        {% for msg in messages %}
            <div class="chat-message">
            <strong>{{ msg.user.username }}:</strong> {{ msg.content }}
            <small>({{ msg.timestamp|date:"Y-m-d H:i" }})</small>
            </div>
        {% endfor %}
</div>

    <div id="typing-indicator" style="color: red; display: none;">
        Someone is typing...
    </div>

    <hr />

    <!-- Message Input -->
    <input id="chat-message-input" type="text" placeholder="Type your message...">
    <button id="chat-message-send">Send</button>

    <!-- Emoji (simple example) -->
    <button id="emoji-button">ðŸ˜€</button>

    <!-- File Upload -->
    <form id="fileUploadForm" enctype="multipart/form-data" method="POST">
      {% csrf_token %}
      <input type="file" name="file" id="fileInput">
      <input type="hidden" name="room_name" value="{{ room_name }}">
      <button type="submit">Upload</button>
    </form>

    <script src="{% static 'uoftsocial/js/jquery-3.5.1.min.js' %}"></script>
    <script>
      const roomName = "{{ room_name }}";
      const chatLog = document.querySelector("#chat-log");
      const typingIndicator = document.querySelector("#typing-indicator");

      // Build the websocket URL
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const chatSocket = new WebSocket(
          protocol + '://'
          + window.location.host
          + '/ws/chat/'
          + roomName
          + '/'
      );

      chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          if(data.type === 'text') {
              const messageEl = document.createElement('div');
              messageEl.innerText = data.username + ": " + data.message;
              chatLog.appendChild(messageEl);
              chatLog.scrollTop = chatLog.scrollHeight;
          } else if(data.type === 'typing') {
              // show typing indicator
              typingIndicator.style.display = 'block';
              // hide it after 2s
              setTimeout(() => {
                  typingIndicator.style.display = 'none';
              }, 2000);
          }
      };

      chatSocket.onclose = function(e) {
          console.error('Chat socket closed unexpectedly');
      };

      // Send message
      const chatMessageInput = document.querySelector("#chat-message-input");
      const chatMessageSend = document.querySelector("#chat-message-send");

      chatMessageSend.onclick = function() {
        const message = chatMessageInput.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'type': 'text'
        }));
        chatMessageInput.value = '';
        };

      // Typing indicator
      chatMessageInput.onkeyup = function(e) {
          chatSocket.send(JSON.stringify({
              'type': 'typing'
          }));
      };

      // Simple emoji button (just appends a smiley)
      const emojiButton = document.querySelector("#emoji-button");
      emojiButton.onclick = function(e) {
          chatMessageInput.value += "ðŸ˜€";
      }

      // File upload via AJAX
      $("#fileUploadForm").submit(function(e) {
          e.preventDefault();

          let formData = new FormData(this);
          $.ajax({
              url: "{% url 'chat-file-upload' %}",
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function(response) {
                  // Optionally, you could inform the WebSocket to show a 'File uploaded' message
                  chatSocket.send(JSON.stringify({
                      'message': 'Uploaded a file',
                      'type': 'text'
                  }));
              },
              error: function(err) {
                  console.log(err);
              }
          });
      });
    </script>
</body>
</html>
